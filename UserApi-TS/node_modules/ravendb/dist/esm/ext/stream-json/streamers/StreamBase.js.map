{"version":3,"file":"StreamBase.js","sourceRoot":"","sources":["../../../../../src/ext/stream-json/streamers/StreamBase.ts"],"names":[],"mappings":"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","sourcesContent":["\r\nimport { Transform } from \"node:stream\";\r\nimport { Assembler } from \"../Assembler.js\";\r\n\r\nclass Counter {\r\n    private depth: number;\r\n    constructor(initialDepth) {\r\n        this.depth = initialDepth;\r\n    }\r\n    startObject() {\r\n        ++this.depth;\r\n    }\r\n    endObject() {\r\n        --this.depth;\r\n    }\r\n    startArray() {\r\n        ++this.depth;\r\n    }\r\n    endArray() {\r\n        --this.depth;\r\n    }\r\n}\r\n\r\nexport class StreamBase extends Transform {\r\n    objectFilter: any;\r\n    includeUndecided: any;\r\n    _assembler: any;\r\n    _wait: any;\r\n    _level: any;\r\n    _saved_assembler: any;\r\n\r\n    constructor(options) {\r\n        super(Object.assign({}, options, {writableObjectMode: true, readableObjectMode: true}));\r\n        if (options) {\r\n            this.objectFilter = options.objectFilter;\r\n            this.includeUndecided = options.includeUndecided;\r\n        }\r\n        if (typeof this.objectFilter != 'function') {\r\n            this._filter = this._transform;\r\n        }\r\n        this._transform = this._wait || this._filter;\r\n        this._assembler = new Assembler(options);\r\n    }\r\n\r\n    _transform(chunk, encoding, callback) {\r\n        if (this._assembler[chunk.name]) {\r\n            this._assembler[chunk.name](chunk.value);\r\n            if (this._assembler.depth === this._level) {\r\n                (this as any)._push();\r\n            }\r\n        }\r\n        callback(null);\r\n    }\r\n\r\n    _filter(chunk, encoding, callback) {\r\n        if (this._assembler[chunk.name]) {\r\n            this._assembler[chunk.name](chunk.value);\r\n            const result = this.objectFilter(this._assembler);\r\n            if (result) {\r\n                if (this._assembler.depth === this._level) {\r\n                    (this as any)._push();\r\n                    this._transform = this._filter;\r\n                }\r\n                this._transform = this._accept;\r\n                return callback(null);\r\n            }\r\n            if (result === false) {\r\n                this._saved_assembler = this._assembler;\r\n                this._assembler = new Counter(this._saved_assembler.depth);\r\n                this._saved_assembler.dropToLevel(this._level);\r\n                if (this._assembler.depth === this._level) {\r\n                    this._assembler = this._saved_assembler;\r\n                    this._transform = this._filter;\r\n                }\r\n                this._transform = this._reject;\r\n                return callback(null);\r\n            }\r\n            if (this._assembler.depth === this._level) {\r\n                (this as any)._push(!this.includeUndecided);\r\n            }\r\n        }\r\n        callback(null);\r\n    }\r\n\r\n    _accept(chunk, encoding, callback) {\r\n        if (this._assembler[chunk.name]) {\r\n            this._assembler[chunk.name](chunk.value);\r\n            if (this._assembler.depth === this._level) {\r\n                (this as any)._push();\r\n                this._transform = this._filter;\r\n            }\r\n        }\r\n        callback(null);\r\n    }\r\n\r\n    _reject(chunk, encoding, callback) {\r\n        if (this._assembler[chunk.name]) {\r\n            this._assembler[chunk.name](chunk.value);\r\n            if (this._assembler.depth === this._level) {\r\n                this._assembler = this._saved_assembler;\r\n                this._transform = this._filter;\r\n            }\r\n        }\r\n        callback(null);\r\n    }\r\n}"]}