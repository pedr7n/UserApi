{"version":3,"file":"LoadStartingWithOperation.js","sourceRoot":"","sources":["../../../../../src/Documents/Session/Operations/LoadStartingWithOperation.ts"],"names":[],"mappings":"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","sourcesContent":["import { InMemoryDocumentSessionOperations } from \"../InMemoryDocumentSessionOperations.js\";\r\nimport { GetDocumentsCommand, GetDocumentsResult } from \"../../Commands/GetDocumentsCommand.js\";\r\nimport { StartingWithOptions } from \"../IDocumentSession.js\";\r\nimport { DocumentInfo } from \"../DocumentInfo.js\";\r\nimport { DocumentType } from \"../../DocumentAbstractions.js\";\r\nimport { TypeUtil } from \"../../../Utility/TypeUtil.js\";\r\nimport { throwError } from \"../../../Exceptions/index.js\";\r\nimport { ObjectTypeDescriptor } from \"../../../Types/index.js\";\r\n\r\nexport class LoadStartingWithOperation {\r\n\r\n    public static DEFAULT: StartingWithOptions = {\r\n        start: 0,\r\n        pageSize: 25,\r\n        exclude: \"\",\r\n        startAfter: \"\",\r\n        matches: \"\"\r\n    };\r\n\r\n    private _session: InMemoryDocumentSessionOperations;\r\n\r\n    private _startWith: string;\r\n    private _matches: string;\r\n    private _start: number;\r\n    private _pageSize: number;\r\n    private _exclude: string;\r\n    private _startAfter: string;\r\n\r\n    private _returnedIds: string[] = [];\r\n    private _resultsSet: boolean;\r\n    private _results: GetDocumentsResult;\r\n\r\n    public constructor(session: InMemoryDocumentSessionOperations) {\r\n        this._session = session;\r\n    }\r\n\r\n    public createRequest(): GetDocumentsCommand {\r\n        this._session.incrementRequestCount();\r\n\r\n        return new GetDocumentsCommand({\r\n            startsWith: this._startWith,\r\n            startsAfter: this._startAfter,\r\n            matches: this._matches,\r\n            exclude: this._exclude,\r\n            start: this._start,\r\n            pageSize: this._pageSize,\r\n            metadataOnly: false,\r\n            conventions: this._session.conventions\r\n        });\r\n    }\r\n\r\n    public withStartWith(idPrefix: string, opts: StartingWithOptions): void {\r\n        const optsToUse: StartingWithOptions = Object.keys(LoadStartingWithOperation.DEFAULT)\r\n            .reduce((result, next) => {\r\n                result[next] = TypeUtil.isNullOrUndefined(opts[next])\r\n                    ? LoadStartingWithOperation.DEFAULT[next]\r\n                    : opts[next];\r\n                return result;\r\n            }, {});\r\n\r\n        this._startWith = idPrefix;\r\n        this._matches = optsToUse.matches;\r\n        this._start = optsToUse.start;\r\n        this._pageSize = optsToUse.pageSize;\r\n        this._exclude = optsToUse.exclude;\r\n        this._startAfter = optsToUse.startAfter;\r\n    }\r\n\r\n    public setResult(result: GetDocumentsResult): void {\r\n        this._resultsSet = true;\r\n\r\n        if (this._session.noTracking) {\r\n            this._results = result;\r\n            return;\r\n        }\r\n\r\n        for (const document of result.results) {\r\n            if (!document) {\r\n                continue;\r\n            }\r\n            const newDocumentInfo = DocumentInfo.getNewDocumentInfo(document);\r\n            this._session.documentsById.add(newDocumentInfo);\r\n            this._returnedIds.push(newDocumentInfo.id);\r\n        }\r\n    }\r\n\r\n    public getDocuments<T extends object>(docType: DocumentType<T>): T[] {\r\n        const entityType = this._session.conventions.getJsTypeByDocumentType<T>(docType);\r\n\r\n        if (this._session.noTracking) {\r\n            if (!this._results) {\r\n                throwError(\r\n                    \"InvalidOperationException\", \"Cannot execute getDocuments before operation execution.\");\r\n            }\r\n\r\n            if (!this._results || !this._results.results || !this._results.results.length) {\r\n                return [];\r\n            }\r\n            \r\n            return this._results.results\r\n                .map(doc => {\r\n                    const newDocumentInfo = DocumentInfo.getNewDocumentInfo(doc);\r\n                    return this._session.trackEntity(entityType, newDocumentInfo);\r\n                });\r\n        }\r\n\r\n        return this._returnedIds.map(id => {\r\n            return this._getDocument(entityType, id);\r\n        });\r\n    }\r\n\r\n    private _getDocument<T extends object>(entityType: ObjectTypeDescriptor<T>, id: string): T | null {\r\n        if (!id) {\r\n            return null;\r\n        }\r\n\r\n        if (this._session.isDeleted(id)) {\r\n            return null;\r\n        }\r\n\r\n        const doc = this._session.documentsById.getValue(id);\r\n        if (doc) {\r\n            return this._session.trackEntity<T>(entityType, doc);\r\n        }\r\n\r\n        return null;\r\n    }\r\n}\r\n"]}