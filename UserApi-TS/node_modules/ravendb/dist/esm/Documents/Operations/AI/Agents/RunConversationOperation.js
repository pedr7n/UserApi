import { RavenCommand } from "../../../../Http/RavenCommand.js";
import { RaftIdGenerator } from "../../../../Utility/RaftIdGenerator.js";
import { throwError } from "../../../../Exceptions/index.js";
import { JsonSerializer } from "../../../../Mapping/Json/Serializer.js";
import { ObjectUtil } from "../../../../Utility/ObjectUtil.js";
import { StringUtil } from "../../../../Utility/StringUtil.js";
export class RunConversationOperation {
    _agentId;
    _conversationId;
    _userPrompt;
    _actionResponses;
    _options;
    _changeVector;
    constructor(agentId, conversationId, userPrompt, actionResponses, options, changeVector) {
        if (StringUtil.isNullOrEmpty(agentId)) {
            throwError("InvalidArgumentException", "agentId cannot be null or empty.");
        }
        if (StringUtil.isNullOrEmpty(conversationId)) {
            throwError("InvalidArgumentException", "conversationId cannot be null or empty.");
        }
        this._agentId = agentId;
        this._conversationId = conversationId;
        this._userPrompt = userPrompt;
        this._actionResponses = actionResponses;
        this._options = options;
        this._changeVector = changeVector;
    }
    get resultType() {
        return "CommandResult";
    }
    getCommand(conventions) {
        return new RunConversationCommand(this._conversationId, this._agentId, this._userPrompt, this._actionResponses, this._options, this._changeVector, conventions);
    }
}
class RunConversationCommand extends RavenCommand {
    _conversationId;
    _agentId;
    _prompt;
    _actionResponses;
    _options;
    _changeVector;
    _raftId;
    constructor(conversationId, agentId, prompt, actionResponses, options, changeVector, conventions) {
        super();
        this._conversationId = conversationId;
        this._agentId = agentId;
        this._prompt = prompt;
        this._actionResponses = actionResponses;
        this._options = options;
        this._changeVector = changeVector;
        if (this._conversationId && this._conversationId.endsWith("|")) {
            this._raftId = RaftIdGenerator.newId();
        }
    }
    get isReadRequest() {
        return false;
    }
    getRaftUniqueRequestId() {
        return this._raftId;
    }
    createRequest(node) {
        const uriParams = new URLSearchParams({
            conversationId: this._conversationId,
            agentId: this._agentId,
        });
        if (this._changeVector) {
            uriParams.append("changeVector", this._changeVector);
        }
        const uri = `${node.url}/databases/${node.database}/ai/agent?${uriParams}`;
        const bodyObj = {
            ActionResponses: this._actionResponses,
            UserPrompt: this._prompt,
            CreationOptions: this._options
        };
        const headers = this._headers().typeAppJson().build();
        // Serialize properties to PascalCase, except "parameters" in CreationOptions, which must keep user-provided, case-sensitive keys unchanged.
        const serialized = ObjectUtil.transformObjectKeys(bodyObj, {
            defaultTransform: ObjectUtil.pascalCase,
            ignorePaths: [
                new RegExp("^CreationOptions\\.Parameters\\..*$")
            ]
        });
        return {
            method: "POST",
            uri,
            headers,
            body: JsonSerializer.getDefault().serialize(serialized)
        };
    }
    async setResponseAsync(bodyStream, fromCache) {
        if (!bodyStream) {
            this._throwInvalidResponse();
        }
        return this._parseResponseDefaultAsync(bodyStream);
    }
}
//# sourceMappingURL=RunConversationOperation.js.map