{"version":3,"file":"AbstractJavaScriptIndexCreationTask.js","sourceRoot":"","sources":["../../../../src/Documents/Indexes/AbstractJavaScriptIndexCreationTask.ts"],"names":[],"mappings":";;;AAAA,6DAA+E;AAC/E,yDAK4B;AAE5B,2DAAqD;AACrD,wDAAuD;AACvD,+DAAyD;AACzD,kFAA4E;AAC5E,qEAA+D;AAC/D,6FAAuF;AACvF,qDAA6C;AAC7C,+DAAyD;AAEzD,MAAa,mCACT,SAAQ,oEAA0D;IAE1D,IAAI,CAAS;IACb,OAAO,CAAS;IAExB;QACI,KAAK,EAAE,CAAC;QAER,IAAI,CAAC,WAAW,GAAG,IAAI,4CAAmB,EAAE,CAAC;IACjD,CAAC;IAED;;;;OAIG;IACI,GAAG,CAAC,wBAA0D,EAAE,UAAwD;QAC3H,IAAI,IAAI,CAAC,IAAI,EAAE,CAAC;YACZ,IAAA,qBAAU,EAAC,2BAA2B,EAClC,oCAAoC;gBACpC,4GAA4G,CAAC,CAAC;QACtH,CAAC;QAED,MAAM,UAAU,GAAG,sBAAQ,CAAC,QAAQ,CAAC,wBAAwB,CAAC;YAC1D,CAAC,CAAC,wBAAwB;YAC1B,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,kBAAkB,CAAC,wBAAwB,CAAC,CAAC;QAEpE,MAAM,iBAAiB,GAAG,IAAI,gCAAa,EAAE,CAAC;QAC9C,0BAAU,CAAC,YAAY,CAAC,iBAAiB,EAAE,UAAU,CAAC,CAAC;QACvD,MAAM,MAAM,GAAG,QAAQ,iBAAiB,CAAC,QAAQ,EAAE,MAAM,UAAU,GAAG,CAAC;QAEvE,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,qBAAqB,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;IAC1D,CAAC;IAED;;;OAGG;IACI,MAAM,CAAC,SAA+C;QACzD,MAAM,SAAS,GAAG,SAAS,CAAC,IAAI,uCAAoB,EAAc,CAAC,CAAC,MAAM,EAAE,CAAC;QAC7E,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,qBAAqB,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;IACnE,CAAC;IAMD,wDAAwD;IACjD,SAAS,CAAC,cAAiC,EAAE,MAAiB;QACjE,IAAI,CAAC,iBAAiB,KAAK,EAAE,CAAC;QAE9B,IAAI,CAAC,sBAAQ,CAAC,QAAQ,CAAC,cAAc,CAAC,EAAE,CAAC;YACrC,OAAO,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,EAAE,cAAc,CAAC,CAAC;QAC/D,CAAC;QAED,MAAM,cAAc,GAAG,MAAM,CAAC,QAAQ,EAAE,CAAC;QAEzC,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE,CAAC;YACvC,IAAA,qBAAU,EAAC,2BAA2B,EAAE,+EAA+E,CAAC,CAAC;QAC7H,CAAC;QAED,IAAI,CAAC,iBAAiB,CAAC,cAAc,CAAC,GAAG,MAAM,CAAC,QAAQ,EAAE,CAAC;IAC/D,CAAC;IAED;;OAEG;IACI,QAAQ;QACX,OAAO,IAAI,+BAAY,EAAE,CAAC;IAC9B,CAAC;IAED,IAAW,WAAW;QAClB,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;IACzB,CAAC;IAEM,qBAAqB;QACxB,MAAM,sBAAsB,GAAG,IAAI,2CAAsB,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC,CAAC;QAC/E,sBAAsB,CAAC,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC;QAC5D,sBAAsB,CAAC,gBAAgB,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAChE,sBAAsB,CAAC,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC;QACvC,sBAAsB,CAAC,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC;QAC7C,sBAAsB,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;QAC1D,sBAAsB,CAAC,kBAAkB,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAClE,sBAAsB,CAAC,kBAAkB,GAAG,IAAI,CAAC,kBAAkB,CAAC;QACpE,sBAAsB,CAAC,qBAAqB,GAAG,IAAI,CAAC,qBAAqB,CAAC;QAC1E,sBAAsB,CAAC,kBAAkB,GAAG,IAAI,CAAC,oBAAoB,CAAC;QACtE,sBAAsB,CAAC,wBAAwB,GAAG,IAAI,CAAC,wBAAwB,CAAC;QAChF,sBAAsB,CAAC,4CAA4C,GAAG,IAAI,CAAC,4CAA4C,CAAC;QACxH,sBAAsB,CAAC,+BAA+B,GAAG,IAAI,CAAC,+BAA+B,CAAC;QAC9F,sBAAsB,CAAC,iBAAiB,GAAG,IAAI,CAAC,iBAAiB,CAAC;QAClE,sBAAsB,CAAC,oBAAoB,GAAG,IAAI,CAAC,oBAAoB,CAAC;QACxE,sBAAsB,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;QAC1D,sBAAsB,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;QAChD,sBAAsB,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;QAChD,sBAAsB,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QAC1C,sBAAsB,CAAC,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC;QAC5D,sBAAsB,CAAC,qBAAqB,GAAG,IAAI,CAAC,qBAAqB,CAAC;QAE1E,IAAI,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACxB,sBAAsB,CAAC,aAAa,CAAC,sBAAO,CAAC,kCAAkC,CAAC,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAC7G,CAAC;aAAM,IAAI,CAAC,0BAAU,CAAC,OAAO,CAAC,IAAI,CAAC,oBAAoB,CAAC,EAAE,CAAC;YACxD,sBAAsB,CAAC,aAAa,CAAC,sBAAO,CAAC,kCAAkC,CAAC,GAAG,OAAO,CAAC;QAC/F,CAAC;QAGD,OAAO,sBAAsB,CAAC,iBAAiB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IACtE,CAAC;CACJ;AA5GD,kFA4GC","sourcesContent":["import { IndexDefinition, IndexDefinitionBuilder } from \"./IndexDefinition.js\";\r\nimport {\r\n    IndexingGroupResults,\r\n    IndexingMapDefinition,\r\n    IndexingMapUtils,\r\n    IndexingReduceDefinition, StubMapUtils\r\n} from \"./StronglyTyped.js\";\r\nimport { DocumentType } from \"../DocumentAbstractions.js\";\r\nimport { TypeUtil } from \"../../Utility/TypeUtil.js\";\r\nimport { throwError } from \"../../Exceptions/index.js\";\r\nimport { StringUtil } from \"../../Utility/StringUtil.js\";\r\nimport { DocumentConventions } from \"../Conventions/DocumentConventions.js\";\r\nimport { StringBuilder } from \"../../Utility/StringBuilder.js\";\r\nimport { BaseJavaScriptIndexCreationTask } from \"./BaseJavaScriptIndexCreationTask.js\";\r\nimport { INDEXES } from \"../../Constants.js\";\r\nimport { ObjectUtil } from \"../../Utility/ObjectUtil.js\";\r\n\r\nexport class AbstractJavaScriptIndexCreationTask<TDocument extends object, TMapResult extends object = any>\r\n    extends BaseJavaScriptIndexCreationTask<keyof TMapResult & string> {\r\n\r\n    private _map: string;\r\n    private _reduce: string;\r\n\r\n    protected constructor() {\r\n        super();\r\n\r\n        this.conventions = new DocumentConventions();\r\n    }\r\n\r\n    /**\r\n     * Register map\r\n     * @param collectionOrDocumentType Collection name to index over\r\n     * @param definition Index definition that maps to the indexed properties\r\n     */\r\n    public map(collectionOrDocumentType: string | DocumentType<TDocument>, definition: IndexingMapDefinition<TDocument, TMapResult>) {\r\n        if (this._map) {\r\n            throwError(\"InvalidOperationException\",\r\n                \"Map function was already defined. \" +\r\n                \"If you are trying to create multi map index, please use AbstractJavaScriptMultiMapIndexCreationTask class.\");\r\n        }\r\n\r\n        const collection = TypeUtil.isString(collectionOrDocumentType)\r\n            ? collectionOrDocumentType\r\n            : this.conventions.findCollectionName(collectionOrDocumentType);\r\n\r\n        const escapedCollection = new StringBuilder();\r\n        StringUtil.escapeString(escapedCollection, collection);\r\n        const rawMap = `map('${escapedCollection.toString()}', ${definition})`;\r\n\r\n        this._map = this.postProcessDefinition(rawMap, \"map\");\r\n    }\r\n\r\n    /**\r\n     * Sets the index definition reduce\r\n     * @param mapReduce Reduce definition\r\n     */\r\n    public reduce(mapReduce: IndexingReduceDefinition<TMapResult>) {\r\n        const rawReduce = mapReduce(new IndexingGroupResults<TMapResult>()).format();\r\n        this._reduce = this.postProcessDefinition(rawReduce, \"reduce\");\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/ban-types\r\n    public addSource(source: Function): void;\r\n    // eslint-disable-next-line @typescript-eslint/ban-types\r\n    public addSource(name: string, source: Function): void;\r\n    // eslint-disable-next-line @typescript-eslint/ban-types\r\n    public addSource(nameOrFunction: string | Function, source?: Function): void {\r\n        this.additionalSources ??= {};\r\n\r\n        if (!TypeUtil.isString(nameOrFunction)) {\r\n            return this.addSource(nameOrFunction.name, nameOrFunction);\r\n        }\r\n\r\n        const sourceAsString = source.toString();\r\n\r\n        if (!sourceAsString.includes(\"function\")) {\r\n            throwError(\"InvalidOperationException\", \"Additional sources require named function. Arrow functions are not supported.\");\r\n        }\r\n\r\n        this.additionalSources[nameOrFunction] = source.toString();\r\n    }\r\n\r\n    /**\r\n     * No implementation is required here, the interface is purely meant to expose map helper methods such as `load(id, collection)` etc\r\n     */\r\n    public mapUtils(): IndexingMapUtils {\r\n        return new StubMapUtils();\r\n    }\r\n\r\n    public get isMapReduce(): boolean {\r\n        return !!this.reduce;\r\n    }\r\n\r\n    public createIndexDefinition(): IndexDefinition {\r\n        const indexDefinitionBuilder = new IndexDefinitionBuilder(this.getIndexName());\r\n        indexDefinitionBuilder.indexesStrings = this.indexesStrings;\r\n        indexDefinitionBuilder.analyzersStrings = this.analyzersStrings;\r\n        indexDefinitionBuilder.map = this._map;\r\n        indexDefinitionBuilder.reduce = this._reduce;\r\n        indexDefinitionBuilder.storesStrings = this.storesStrings;\r\n        indexDefinitionBuilder.suggestionsOptions = this.indexSuggestions;\r\n        indexDefinitionBuilder.termVectorsStrings = this.termVectorsStrings;\r\n        indexDefinitionBuilder.spatialIndexesStrings = this.spatialOptionsStrings;\r\n        indexDefinitionBuilder.vectorFieldStrings = this.vectorOptionsStrings;\r\n        indexDefinitionBuilder.outputReduceToCollection = this.outputReduceToCollection;\r\n        indexDefinitionBuilder.patternForOutputReduceToCollectionReferences = this.patternForOutputReduceToCollectionReferences;\r\n        indexDefinitionBuilder.patternReferencesCollectionName = this.patternReferencesCollectionName;\r\n        indexDefinitionBuilder.additionalSources = this.additionalSources;\r\n        indexDefinitionBuilder.additionalAssemblies = this.additionalAssemblies;\r\n        indexDefinitionBuilder.configuration = this.configuration;\r\n        indexDefinitionBuilder.lockMode = this.lockMode;\r\n        indexDefinitionBuilder.priority = this.priority;\r\n        indexDefinitionBuilder.state = this.state;\r\n        indexDefinitionBuilder.deploymentMode = this.deploymentMode;\r\n        indexDefinitionBuilder.compoundFieldsStrings = this.compoundFieldsStrings;\r\n\r\n        if (this.searchEngineType) {\r\n            indexDefinitionBuilder.configuration[INDEXES.INDEXING_STATIC_SEARCH_ENGINE_TYPE] = this.searchEngineType;\r\n        } else if (!ObjectUtil.isEmpty(this.vectorOptionsStrings)) {\r\n            indexDefinitionBuilder.configuration[INDEXES.INDEXING_STATIC_SEARCH_ENGINE_TYPE] = \"Corax\";\r\n        }\r\n\r\n\r\n        return indexDefinitionBuilder.toIndexDefinition(this.conventions);\r\n    }\r\n}\r\n"]}