{"version":3,"file":"FacetQueryCommand.js","sourceRoot":"","sources":["../../../../src/Documents/Commands/FacetQueryCommand.ts"],"names":[],"mappings":";;;AAGA,uDAAiD;AACjD,gGAA0F;AAE1F,+DAAyD;AACzD,2DAAqD;AAErD,MAAa,iBAAkB,SAAQ,8BAAY;IAExC,KAAK,CAAC,gBAAgB,CAAC,UAAkB,EAAE,SAAkB;QAChE,IAAI,CAAC,UAAU,EAAE,CAAC;YACd,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;YACnB,OAAO;QACX,CAAC;QAED,IAAI,IAAI,GAAW,IAAI,CAAC;QACxB,IAAI,CAAC,MAAM,GAAG,MAAM,iBAAiB,CAAC,6BAA6B,CAC/D,UAAU,EAAE,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,SAAS,EAAE,CAAC,CAAC,EAAE,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC;QAErE,OAAO,IAAI,CAAC;IAChB,CAAC;IAEM,MAAM,CAAC,KAAK,CAAC,6BAA6B,CAC7C,UAAkB,EAClB,WAAgC,EAChC,SAAkB,EAClB,YAAqC;QAErC,MAAM,SAAS,GAAG,MAAM,8DAA4B,CAAC,MAAM,EAA6C;aACnG,WAAW,CAAC,YAAY,CAAC;aACzB,aAAa,EAAE;aACf,OAAO,CAAC,UAAU,CAAC,CAAC;QAEzB,MAAM,WAAW,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,SAAS,EAAE,WAAW,CAAC,CAAC;QAE/E,IAAI,SAAS,EAAE,CAAC;YACZ,WAAW,CAAC,YAAY,GAAG,CAAC,CAAC,CAAC;QAClC,CAAC;QAED,OAAO,WAAW,CAAC;IACvB,CAAC;IAEM,MAAM,CAAC,gBAAgB,CAAC,IAA+C,EAAE,WAAgC;QAC5G,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,cAAc,EAAE,aAAa,EAAE,GAAG,IAAI,EAAE,GAAG,IAAI,CAAC;QAE3E,MAAM,UAAU,GAAG,0BAAU,CAAC,mBAAmB,CAAC,IAAI,EAAE;YACpD,gBAAgB,EAAE,0BAAU,CAAC,KAAK;SACrC,CAAQ,CAAC;QAEV,OAAO;YACH,GAAG,UAAU;YACb,cAAc,EAAE,sBAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,cAAc,CAAC;YAClD,aAAa,EAAE,sBAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,aAAa,CAAC;YAChD,OAAO,EAAE,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,0BAAU,CAAC,mBAAmB,CAAC,CAAC,EAAE,EAAE,gBAAgB,EAAE,0BAAU,CAAC,KAAK,EAAE,CAAC,CAAC;YACpG,QAAQ,EAAE,0BAAU,CAAC,wBAAwB,CAAC,IAAI,CAAC,QAAQ,EAAE,WAAW,CAAC;SAC5E,CAAC;IACN,CAAC;CACJ;AAlDD,8CAkDC","sourcesContent":["import { QueryResult } from \"../Queries/QueryResult.js\";\r\nimport { DocumentConventions } from \"../Conventions/DocumentConventions.js\";\r\nimport { Stream } from \"node:stream\";\r\nimport { QueryCommand } from \"./QueryCommand.js\";\r\nimport { RavenCommandResponsePipeline } from \"../../Http/RavenCommandResponsePipeline.js\";\r\nimport { ServerCasing, ServerResponse } from \"../../Types/index.js\";\r\nimport { ObjectUtil } from \"../../Utility/ObjectUtil.js\";\r\nimport { DateUtil } from \"../../Utility/DateUtil.js\";\r\n\r\nexport class FacetQueryCommand extends QueryCommand {\r\n\r\n    public async setResponseAsync(bodyStream: Stream, fromCache: boolean): Promise<string> {\r\n        if (!bodyStream) {\r\n            this.result = null;\r\n            return;\r\n        }\r\n\r\n        let body: string = null;\r\n        this.result = await FacetQueryCommand.parseQueryResultResponseAsync(\r\n            bodyStream, this._session.conventions, fromCache, b => body = b);\r\n\r\n        return body;\r\n    }\r\n\r\n    public static async parseQueryResultResponseAsync(\r\n        bodyStream: Stream,\r\n        conventions: DocumentConventions,\r\n        fromCache: boolean,\r\n        bodyCallback?: (body: string) => void): Promise<QueryResult> {\r\n\r\n        const rawResult = await RavenCommandResponsePipeline.create<ServerCasing<ServerResponse<QueryResult>>>()\r\n            .collectBody(bodyCallback)\r\n            .parseJsonSync()\r\n            .process(bodyStream);\r\n\r\n        const queryResult = FacetQueryCommand.mapToLocalObject(rawResult, conventions);\r\n\r\n        if (fromCache) {\r\n            queryResult.durationInMs = -1;\r\n        }\r\n\r\n        return queryResult;\r\n    }\r\n\r\n    public static mapToLocalObject(json: ServerCasing<ServerResponse<QueryResult>>, conventions: DocumentConventions): QueryResult {\r\n        const { Results, Includes, IndexTimestamp, LastQueryTime, ...rest } = json;\r\n\r\n        const restMapped = ObjectUtil.transformObjectKeys(rest, {\r\n            defaultTransform: ObjectUtil.camel\r\n        }) as any;\r\n\r\n        return {\r\n            ...restMapped,\r\n            indexTimestamp: DateUtil.utc.parse(IndexTimestamp),\r\n            lastQueryTime: DateUtil.utc.parse(LastQueryTime),\r\n            results: Results.map(x => ObjectUtil.transformObjectKeys(x, { defaultTransform: ObjectUtil.camel })),\r\n            includes: ObjectUtil.mapIncludesToLocalObject(json.Includes, conventions)\r\n        };\r\n    }\r\n}\r\n"]}